<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¸å¹´çµ‚å°¾ç‰™æŠ½çç³»çµ±</title>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- canvas-confetti for celebration effects -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
</head>

<body>

    <header class="header">
        <div id="groupTitleDisplay"
            style="font-size: 1.2rem; color: rgba(255,255,255,0.9); margin-bottom: 0.3rem; font-weight: 500; letter-spacing: 2px; display: none;">
        </div>
        <h1 id="headerTitle" style="font-size: 2.8rem; border: none; padding: 0; margin: 0;">ğŸ‰ å¹´çµ‚å°¾ç‰™å¤§æŠ½ç ğŸ‰</h1>
        <div id="subtitleDisplay"
            style="font-size: 1.3rem; color: rgba(255,255,255,0.95); font-weight: 400; margin-top: 0.3rem; display: none;">
        </div>
    </header>

    <div class="container">
        <!-- Sidebar for Inputs -->
        <div class="sidebar">
            <div class="sidebar-tabs">
                <button id="tabDraw" class="tab-btn active">æŠ½çæ¨¡å¼</button>
                <button id="tabSettings" class="tab-btn">è¨­å®šåå–®</button>
            </div>
            <div style="text-align: center; margin-bottom: 1rem;">
                <button id="viewParticipantsBtn" class="btn btn-secondary"
                    style="font-size: 0.9rem; padding: 0.5rem; background-color: #6c757d;">ğŸ‘¥ æŸ¥çœ‹æœªä¸­çåå–®</button>
            </div>

            <!-- Draw Mode: Interactive Prize List -->
            <div id="drawModePanel" class="panel active">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;">è«‹é»é¸çé …ï¼š</h3>
                    <button id="quickAddPrizeBtn"
                        style="padding: 2px 10px; font-size: 1.2rem; font-weight:bold; cursor: pointer; background: #28a745; color: white; border: none; border-radius: 4px; line-height:1;">+</button>
                </div>
                <ul id="prizeListDisplay" class="prize-list-display">
                    <!-- JS will populate clickable prizes here -->
                </ul>
            </div>

            <!-- Settings Mode: Text Inputs -->
            <div id="settingsModePanel" class="panel" style="display: none;">
                <div class="input-group">
                    <label for="groupTitleInput">å…¬å¸ / åœ˜é«”åç¨± (é¸å¡«)</label>
                    <input type="text" id="groupTitleInput" placeholder="ä¾‹å¦‚ï¼šæŸæŸè‚¡ä»½æœ‰é™å…¬å¸"
                        style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #ccc; border-radius: 6px;">
                </div>

                <div class="input-group">
                    <label for="titleInput">æ´»å‹•æ¨™é¡Œ</label>
                    <input type="text" id="titleInput" value="ğŸ‰ å¹´çµ‚å°¾ç‰™å¤§æŠ½ç ğŸ‰"
                        style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #ccc; border-radius: 6px;">
                </div>

                <div class="input-group">
                    <label for="subtitleInput">æ´»å‹•å‰¯æ¨™é¡Œ / ç¥ç¦èª (é¸å¡«)</label>
                    <input type="text" id="subtitleInput" placeholder="ä¾‹å¦‚ï¼šç¥å„ä½åŒä» å¥½é‹é€£é€£ æ°£æ»¿æ»¿"
                        style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #ccc; border-radius: 6px;">
                </div>

                <div class="input-group">
                    <label for="eventDateInput">æ´»å‹•æ—¥æœŸ</label>
                    <input type="date" id="eventDateInput"
                        style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; border: 1px solid #ccc; border-radius: 6px;">
                </div>

                <div class="input-group">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 0.5rem;">
                        <label for="sheetsUrlInput" style="color: #4285f4; margin: 0;">ğŸ“Š Google Sheets Web App
                            URL</label>
                        <button id="helpBtn" title="æŸ¥çœ‹è¨­å®šæ•™å­¸"
                            style="width: 20px; height: 20px; border-radius: 50%; border: 1px solid #4285f4; background: white; color: #4285f4; cursor: pointer; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0;">?</button>
                    </div>
                    <input type="text" id="sheetsUrlInput" placeholder="https://script.google.com/macros/s/.../exec"
                        style="width: 100%; padding: 0.5rem; border: 1px solid #4285f4; border-radius: 6px;">
                    <small style="color: #888; display: block; margin-top: 4px;">ç”± Google Sheets è‡ªå‹•å„²å­˜ç´€éŒ„ã€‚</small>
                    <div style="display: flex; gap: 8px; margin-top: 0.5rem;">
                        <button id="testSheetsBtn" class="btn"
                            style="width: auto; padding: 4px 12px; font-size: 0.8rem; background: #e8f0fe; color: #1967d2; border: 1px solid #1967d2;">æ¸¬è©¦é€£ç·š</button>
                        <button id="syncManualBtn" class="btn"
                            style="width: auto; padding: 4px 12px; font-size: 0.8rem; background: #fdf2f2; color: #d93025; border: 1px solid #d93025;">è£œå‚³æ‰€æœ‰ç´€éŒ„</button>
                    </div>
                </div>

                <div class="input-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem;">
                    <input type="checkbox" id="allowRepeat" style="width: 20px; height: 20px;">
                    <label for="allowRepeat" style="margin-bottom: 0; cursor: pointer;">å…è¨±é‡è¤‡ä¸­ç (å·²ä¸­çè€…å¯å†æ¬¡ä¸­ç)</label>
                </div>

                <div class="input-group">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="margin: 0;">çé …æ¸…å–®</label>
                        <button id="clearPrizesBtn" class="btn"
                            style="width: auto; padding: 2px 8px; font-size: 0.75rem; background: #6c757d; color: white; border-radius: 4px;">æ¸…ç©ºçé …</button>
                    </div>
                    <div id="prizeRowsContainer" class="prize-rows-container">
                        <!-- JS generated rows -->
                    </div>
                    <button id="addPrizeRowBtn" class="btn btn-secondary"
                        style="width:100%; margin-top:0.5rem; background:#eee; color:#333; border:1px dashed #ccc;">+
                        æ–°å¢ä¸€è¡Œ</button>
                    <!-- Hidden textarea for backward compatibility if needed, or just remove it -->
                    <textarea id="prizeInput" style="display:none;"></textarea>
                </div>

                <div class="input-group">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <label style="margin: 0;" for="nameInput">åƒåŠ äººå“¡åå–® (ä¸€è¡Œä¸€å€‹)</label>
                        <button id="clearNamesBtn" class="btn"
                            style="width: auto; padding: 2px 8px; font-size: 0.75rem; background: #6c757d; color: white; border-radius: 4px;">æ¸…ç©ºåå–®</button>
                    </div>
                    <textarea id="nameInput" placeholder="è¼¸å…¥äººå..."></textarea>
                </div>

                <div class="settings-actions" style="display: flex; gap: 10px;">
                    <button id="saveSettingsBtn" class="btn btn-primary" style="flex: 2;">å„²å­˜ä¸¦æ›´æ–°</button>
                    <button id="loadExampleBtn" class="btn btn-secondary"
                        style="flex: 1; background-color: #6c757d;">è¼‰å…¥ç¯„ä¾‹</button>
                </div>

                <div id="settingsHistoryPanel" style="margin-top: 2rem; border-top: 2px solid #eee; padding-top: 1rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <h3 style="color: #666; font-size: 1.1rem; margin: 0;">ğŸ“œ ç›®å‰ä¸­çç´€éŒ„å‚™ä»½ (å”¯è®€)</h3>
                        <button id="clearHistoryBtn" class="btn"
                            style="width: auto; padding: 4px 10px; font-size: 0.8rem; background: #dc3545; color: white; border-radius: 4px;">æ¸…ç©ºæ­·å²ç´€éŒ„</button>
                    </div>
                    <ul id="settingsHistoryList"
                        style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto; background: #f9f9f9; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                        <!-- Populated by JS -->
                    </ul>
                </div>
            </div>
        </div>

        <!-- Main Display Area -->
        <div class="main-content">
            <div class="display-area">
                <div class="current-prize" id="currentPrizeLabel">æº–å‚™é–‹å§‹æŠ½ç...</div>
                <div class="winner-display" id="winnerDisplay">???</div>

                <div class="controls-options" style="margin-bottom: 1rem;">
                    <input type="checkbox" id="drawAllowRepeat">
                    <label for="drawAllowRepeat"
                        style="cursor: pointer; font-weight: bold; color: #555;">æœ¬æ¬¡æŠ½çå…è¨±é‡è¤‡ä¸­ç</label>
                </div>

                <div class="controls">
                    <button id="mainActionBtn" class="btn btn-action btn-start">é–‹å§‹æŠ½ç</button>
                </div>
            </div>
        </div>

        <!-- Results Section (Right Sidebar) -->
        <div class="results-area">
            <h2>ğŸ† ä¸­çåå–®</h2>
            <ul id="resultsList" class="results-list">
                <!-- Results will be added here dynamically -->
            </ul>
            <div style="text-align: right; margin-top: 1rem;">
                <button id="resetBtn" class="btn btn-secondary"
                    style="width: auto; display: inline-block;">é‡ç½®æ‰€æœ‰çµæœ</button>
            </div>
        </div>
    </div>

    <!-- Festive Canvas for Confetti (Optional, can be added later) -->

    <!-- Quick Add Prize Modal -->
    <div id="quickAddModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close-quick-add">&times;</span>
            <h2 style="margin-top:0; color:var(--primary-color);">+ åŠ ç¢¼çé …</h2>
            <div class="input-group">
                <label>çé …æ¨™é¡Œ (ä¾‹å¦‚: åŠ ç¢¼ç´…åŒ…)</label>
                <input type="text" id="qaTitle"
                    style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <div class="input-group">
                <label>çå“å…§å®¹ (ä¾‹å¦‚: ç¾é‡‘1åƒå…ƒ)</label>
                <input type="text" id="qaContent"
                    style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <div class="input-group">
                <label>æ•¸é‡</label>
                <input type="number" id="qaCount" value="1" min="1"
                    style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <div style="text-align:right; margin-top:1rem;">
                <button id="confirmQuickAddBtn" class="btn btn-primary">ç¢ºå®šæ–°å¢</button>
            </div>
        </div>
    </div>

    <!-- Remaining Prizes Modal -->
    <div id="remainingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>ğŸ“Š å‰©é¤˜çé …ä¸€è¦½</h2>
            <ul id="remainingList" class="remaining-list">
                <!-- JS Populated -->
            </ul>
        </div>
    </div>

    <!-- Google Sheets Help Modal -->
    <div id="sheetsHelpModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px; text-align: left;">
            <span id="closeHelpModal" class="close-modal">&times;</span>
            <h2 style="color: #4285f4; margin-top: 0;">ğŸ“Š å¦‚ä½•é€£çµ Google Sheets</h2>
            <div
                style="font-size: 0.95rem; line-height: 1.6; color: #444; max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                <p>è«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿå®Œæˆè¨­å®šï¼Œå³å¯å¯¦ç¾æŠ½ççµæœè‡ªå‹•åŒæ­¥ï¼š</p>
                <ol>
                    <li><b>å»ºç«‹è©¦ç®—è¡¨</b>ï¼šé–‹å•Ÿä¸€ä»½æ–°çš„ Google è©¦ç®—è¡¨ã€‚</li>
                    <li><b>é–‹å•ŸæŒ‡ä»¤ç¢¼ç·¨è¼¯å™¨</b>ï¼šé»æ“Šä¸Šæ–¹çš„ã€Œæ“´å……åŠŸèƒ½ã€ > ã€ŒApps Scriptã€ã€‚</li>
                    <li><b>è²¼ä¸ŠæŒ‡ä»¤ç¢¼</b>ï¼šåˆªé™¤é è¨­ç¨‹å¼ç¢¼ï¼Œä¸¦è²¼ä¸Šä»¥ä¸‹å…§å®¹ï¼š
                        <div style="position: relative; margin: 10px 0;">
                            <button id="copyCodeBtn"
                                style="position: absolute; right: 5px; top: 5px; padding: 4px 10px; font-size: 0.75rem; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; z-index: 10;">ä¸€éµè¤‡è£½ç¨‹å¼ç¢¼</button>
                            <pre id="gasCodeSnippet"
                                style="background: #f4f4f4; padding: 35px 10px 10px 10px; border-radius: 4px; overflow-x: auto; font-size: 0.85rem; border: 1px solid #ddd; margin: 0;">
function doPost(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var data = JSON.parse(e.postData.contents);
  var sheetName = (data.eventName + "-" + data.eventDate).replace(/[\\\/\?\*\[\]]/g, "").substring(0, 31);
  var sheet = ss.getSheetByName(sheetName) || ss.insertSheet(sheetName);
  var lastCol = 7; 

  // 1. å¼·åˆ¶æª¢æŸ¥ã€Œå…¬å¸åç¨±å¤§æ¨™é¡Œã€ (è‹¥æœ‰è¨­å®šå°±ä¸€å®šè¦åœ¨ç¬¬ä¸€åˆ—)
  if (data.groupTitle) {
    if (sheet.getLastRow() == 0 || sheet.getRange(1, 1).getValue() != data.groupTitle) {
      sheet.insertRowBefore(1);
      sheet.getRange(1, 1, 1, lastCol).merge().setValue(data.groupTitle)
           .setFontWeight("bold").setHorizontalAlignment("center").setBackground("#eeeeee");
    }
  }

  // 2. ç¢ºä¿ã€Œæ¬„ä½æ¨™é¡Œã€åˆ—çµæ§‹æ­£ç¢º (åŒ…å«å”¯ä¸€ID)
  var headerRowIdx = (data.groupTitle ? 2 : 1);
  var headerValues = sheet.getRange(headerRowIdx, 1, 1, lastCol).getValues()[0];
  if (headerValues[0] != "ç´€éŒ„æ™‚é–“" || headerValues[6] != "å”¯ä¸€ID") {
    // è‹¥æ¨™é¡Œåˆ—ä¸è¦å¾‹æˆ–ç¼ºæ¬„ä½ï¼Œå¼·åˆ¶å¯«å…¥æ­£ç¢ºçš„æ¨™é¡Œæ¶æ§‹
    sheet.getRange(headerRowIdx, 1, 1, lastCol).setValues([["ç´€éŒ„æ™‚é–“", "æ´»å‹•åç¨±", "æ´»å‹•æ—¥æœŸ", "çé …æ¨™é¡Œ", "çå“å…§å®¹", "ä¸­çåå–®", "å”¯ä¸€ID"]]);
    sheet.getRange(headerRowIdx, 1, 1, lastCol).setFontWeight("bold").setBackground("#f3f3f3");
    sheet.setFrozenRows(headerRowIdx);
  }

  // 3. åš´æ ¼æ’é‡æª¢æŸ¥ (æ¯”å°ç¬¬ä¸ƒæ¬„ Column G çš„å”¯ä¸€ID)
  var drawId = data.drawId;
  if (drawId) {
    var range = sheet.getDataRange();
    var values = range.getValues();
    for (var i = 0; i < values.length; i++) {
        // ID å¿…å®šåœ¨ç¬¬ 7 æ¬„ (index 6)
        if (values[i][6] == drawId) return ContentService.createTextOutput("Duplicate skipped");
    }
  }

  // 4. å¯«å…¥ä¸­çè³‡æ–™
  sheet.appendRow([new Date(), data.eventName, data.eventDate, data.prizeTitle, data.prizeContent, data.winnerName, drawId]);
  return ContentService.createTextOutput("Success");
}</pre>
                        </div>
                    </li>
                    <li><b>éƒ¨ç½²ç‚ºç¶²é æ‡‰ç”¨ç¨‹å¼</b>ï¼š
                        <ul>
                            <li>é»æ“Šå³ä¸Šæ–¹ã€Œéƒ¨ç½²ã€ > ã€Œæ–°éƒ¨ç½²ã€ã€‚</li>
                            <li>é¸å–é¡å‹ï¼š<b>ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€</b>ã€‚</li>
                            <li>åŸ·è¡Œèº«åˆ†ï¼š<b>ã€Œæˆ‘ã€</b>ã€‚</li>
                            <li>èª°æœ‰å­˜å–æ¬Šï¼š<b>ã€Œæ‰€æœ‰äººã€</b> (Anyone)ã€‚</li>
                        </ul>
                    </li>
                    <li><b>è¤‡è£½ç¶²å€</b>ï¼šé»æ“Šã€Œéƒ¨ç½²ã€ï¼Œå®Œæˆå¾Œè¤‡è£½ç”¢ç”Ÿçš„<b>ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ã€</b>ã€‚</li>
                    <li><b>å®Œæˆé€£çµ</b>ï¼šå°‡è©²ç¶²å€è²¼å›æŠ½çç¶²é çš„è¨­å®šæ¬„ä½ï¼Œä¸¦é»æ“Š<b>ã€Œå„²å­˜ä¸¦æ›´æ–°ã€</b>ã€‚</li>
                </ol>
                <p
                    style="color: #d93025; font-size: 0.85rem; background: #fef7f7; padding: 8px; border-radius: 4px; border: 1px solid #f8d7da;">
                    âš ï¸ æ³¨æ„ï¼šè‹¥ä¹‹å¾Œä¿®æ”¹äº† Apps Script ç¨‹å¼ç¢¼ï¼Œè«‹å‹™å¿…é‡æ–°éƒ¨ç½²ä¸¦é¸æ“‡ã€Œæ–°ç‰ˆæœ¬ã€ï¼Œå¦å‰‡è®Šæ›´ä¸æœƒç”Ÿæ•ˆã€‚
                </p>
            </div>
            <div style="text-align: right; margin-top: 1.5rem;">
                <button onclick="document.getElementById('sheetsHelpModal').style.display='none'"
                    class="btn btn-secondary" style="width: auto; padding: 8px 20px;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Winner Celebration Overlay -->
    <div id="celebrationOverlay" class="celebration-overlay" style="display: none;">
        <div class="celebration-content">
            <div class="celebration-badge">æ­å–œä¸­ç</div>
            <div id="celebrationPrize" class="celebration-prize">ç‰¹çï¼šiPhone 15</div>
            <div id="celebrationWinner" class="celebration-winner">ä¸­çäººå§“å</div>
            <div class="celebration-hint">é»æ“Šè¢å¹•é—œé–‰</div>
        </div>
    </div>

    <script src="js/lucky-draw.js"></script>
</body>

</html>